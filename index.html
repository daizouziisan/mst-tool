<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>睡眠記録</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: 'Noto Sans JP', sans-serif; background: #dff6fd; color: #000; }
    .header, .footer { padding: 1rem; text-align: center; }
    .header-form { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; margin-top: 1rem; }
    .header-form label { display: flex; justify-content: center; align-items: center; gap: 0.5rem; }
    .header-form input[type="time"], .header-form input[type="number"] {
      padding: 0.1rem; border-radius: 4px; border: 1px solid #aaa; width: 80px; text-align: center;
    }
    .day-block { margin: 1rem auto; background: #f0fbff; padding: 1rem; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 480px; text-align: center; }
    .day-title { font-size: 1.2rem; margin-bottom: 0.5rem; color: #007acc; }
    .table-grid { display: grid; grid-template-columns: 1fr 0.3fr 1fr 0.8fr 1fr 1fr; align-items: center; text-align: center; font-size: 0.9rem; margin-bottom: 0.3rem; }
    .input-cell { display: flex; justify-content: center; }
    button { background: #66ccff; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; margin: 0.5rem auto; display: block; }
    canvas { max-width: 95%; margin: 1rem auto; display: block; background: #e9faff; }
    .stars { margin-top: 1rem; text-align: center; }
    .stars img { width: 60px; margin: 0 5px; }
    #suggestionResult div { margin: 0.3rem 0; }
  </style>
</head>
<body>
<div class="header">
  <h2>睡眠スケジュール</h2>
  <div class="header-form">
    <label>就寝予定時刻:<input type="time" id="plannedStart"></label>
    <label>希望睡眠時間(分):<input type="number" id="desiredDuration" min="0" max="1440" step="1"></label>
    <label>MST:<input type="time" id="targetMST"></label>
    <button onclick="suggestSleepTime()">提案</button>
    <div id="suggestionResult"></div>
  </div>
</div>

<div id="daysContainer"></div>

<div class="footer">
  <h3>週の統計とグラフ</h3>
  <button onclick="evaluateAll()">週の評価</button>
  <div id="weeklyStats"></div>
  <canvas id="mstChart" height="420"></canvas>
  <div class="stars" id="starRatings"></div>
</div>

<script>
const weekdays = ["mon","tue","wed","thu","fri","sat","sun"];
const labels = ["月","火","水","木","金","土","日"];
const container = document.getElementById("daysContainer");
const CUTOFF_MIN = 4 * 60; // 04:00

/* ---------- utils ---------- */
function focusNext(current, nextId) { if (current.value) document.getElementById(nextId).focus(); }
function timeToMin(t){ if(!t) return null; const [h,m]=t.split(":").map(Number); return h*60+m; }
function minToTime(min){ min=(min+1440)%1440; const h=String(Math.floor(min/60)).padStart(2,"0"); const m=String(min%60).padStart(2,"0"); return `${h}:${m}`; }
function nextIndex(i){ return (i+1) % 7; }
function dayLabel(i){ return labels[(i+7)%7]; }

/* ---------- day inputs ---------- */
weekdays.forEach((day, i) => {
  const block = document.createElement("div");
  block.className = "day-block";
  block.innerHTML = `<div class='day-title'>${labels[i]}曜日</div>
    <div class='table-grid'><div>就寝</div><div></div><div>起床</div><div>点数</div><div>合計</div><div>MST</div></div>
    <div class='table-grid'>
      <div class='input-cell'><input type='time' id='${day}_s1' oninput="focusNext(this, '${day}_w1'); evaluateAll();"></div>
      <div>〜</div>
      <div class='input-cell'><input type='time' id='${day}_w1' oninput="evaluateAll();"></div>
      <div id='${day}_score1'>--点</div><div></div><div></div>
    </div>
    <div class='table-grid'><div></div><div></div><div></div><div></div>
      <div id='${day}_total'>--h--m</div><div id='${day}_mst'>--:--</div></div>
    <div class='table-grid'>
      <div class='input-cell'><input type='time' id='${day}_s2' oninput="focusNext(this, '${day}_w2'); evaluateAll();"></div>
      <div>〜</div>
      <div class='input-cell'><input type='time' id='${day}_w2' oninput="evaluateAll();"></div>
      <div id='${day}_score2'>--点</div><div></div><div></div>
    </div>`;
  container.appendChild(block);
});

/* ---------- clear ---------- */
const clearBtn = document.createElement("button");
clearBtn.textContent = "消去";
clearBtn.onclick = () => {
  weekdays.forEach(day => {
    ["s1","w1","s2","w2"].forEach(t => document.getElementById(`${day}_${t}`).value = "");
    document.getElementById(`${day}_total`).innerText = "--h--m";
    document.getElementById(`${day}_mst`).innerText = "--:--";
    document.getElementById(`${day}_score1`).innerText = "--点";
    document.getElementById(`${day}_score2`).innerText = "--点";
  });
  document.getElementById("weeklyStats").innerText = "";
  document.getElementById("starRatings").innerHTML = "";
  Chart.getChart("mstChart")?.destroy();
};
container.appendChild(clearBtn);

/* ---------- proposal ---------- */
function suggestSleepTime() {
  const start = timeToMin(document.getElementById("plannedStart").value);
  const duration = parseInt(document.getElementById("desiredDuration").value);
  const targetMST = timeToMin(document.getElementById("targetMST").value);
  const resultDiv = document.getElementById("suggestionResult");
  resultDiv.innerHTML = "";
  if (start == null || isNaN(duration) || targetMST == null) {
    resultDiv.innerText = "入力が不完全です。"; return;
  }
  let candidates = [];
  for (let i = 0; i <= 180; i += 5) {
    let s = (start + i) % 1440;
    let maxDur = Math.min(duration, 1440 - i);
    for (let d = maxDur; d >= 30; d -= 5) {
      let e = (s + d) % 1440;
      let mst = (s + d / 2) % 1440;
      let diff = Math.min(Math.abs(mst - targetMST), 1440 - Math.abs(mst - targetMST));
      if (diff <= 30) { candidates.push({s,e,d,mst,offset:i}); break; }
    }
  }
  if (candidates.length === 0){ resultDiv.innerText = "適した時間帯が見つかりません。"; return; }
  candidates.sort((a,b)=> a.offset-b.offset || b.d-a.d);
  candidates.slice(0,3).forEach(c=>{
    const div=document.createElement("div");
    div.innerText = `${minToTime(c.s)}〜${minToTime(c.e)} (${c.d}分 / MST:${minToTime(c.mst)})`;
    resultDiv.appendChild(div);
  });
}

/* ---------- evaluate + chart ---------- */
function evaluateAll() {
  let count = 0, totals = [], msts = [];

  // グラフ用データ（浮動バー）
  const dsSleep = []; // 通常
  const dsMST   = []; // MST帯（±3分）

  function addBar(dayIdx, start, end){
    dsSleep.push({x: dayLabel(dayIdx), y: [start, end]});
  }
  function addMSTbar(dayIdx, mst){
    const a = Math.max(0, mst - 3), b = Math.min(1440, mst + 3);
    dsMST.push({x: dayLabel(dayIdx), y: [a, b]});
  }

  weekdays.forEach((day, i) => {
    const s1 = timeToMin(document.getElementById(`${day}_s1`).value);
    const w1 = timeToMin(document.getElementById(`${day}_w1`).value);
    const s2 = timeToMin(document.getElementById(`${day}_s2`).value);
    const w2 = timeToMin(document.getElementById(`${day}_w2`).value);

    // 数値（従来ロジック）
    const d1 = (s1!=null && w1!=null) ? (w1 - s1 + 1440) % 1440 : 0;
    const d2 = (s2!=null && w2!=null) ? (w2 - s2 + 1440) % 1440 : 0;
    const total = d1 + d2;
    const mstDay = (d1>=d2 && d1>0) ? (s1 + d1/2) % 1440 : (d2>0 ? (s2 + d2/2) % 1440 : null);

    const score1 = d1 > 0 ? Math.min(100, Math.round(d1 / 5.1)) : 0;
    const score2 = d2 > 0 ? Math.min(100 - score1, Math.round(d2 / 5.1)) : 0;

    document.getElementById(`${day}_total`).innerText = total > 0 ? `${Math.floor(total/60)}h${total%60}m` : "--h--m";
    document.getElementById(`${day}_mst`).innerText   = mstDay != null ? minToTime(mstDay) : "--:--";
    document.getElementById(`${day}_score1`).innerText= `${score1}点`;
    document.getElementById(`${day}_score2`).innerText= `${score2}点`;

    if (total > 0 && mstDay != null) { count++; totals.push(total); msts.push(mstDay); }

    // ===== グラフ描画ロジック =====
    // 1回目（通常の日跨ぎ処理：後半は翌日の列へ）
    if (d1 > 0){
      if (w1 > s1){ // 日跨ぎなし
        addBar(i, s1, w1);
        addMSTbar(i, (s1 + d1/2) % 1440);
      } else { // 日跨ぎ
        addBar(i, s1, 1440);                 // 当日分
        addBar(nextIndex(i), 0, w1);         // 翌日分
        const mst1 = (s1 + d1/2) % 1440;
        // MSTがどちら側にあるかで置き先を決める
        if (mst1 >= s1) addMSTbar(i, mst1); else addMSTbar(nextIndex(i), mst1);
      }
    }

    // 2回目（午前4時以降に開始したら翌日の列に置く仕様）
    if (d2 > 0){
      const targetDay = (s2 != null && s2 >= CUTOFF_MIN) ? nextIndex(i) : i;

      if (w2 > s2){ // 日跨ぎなし
        addBar(targetDay, s2, w2);
        addMSTbar(targetDay, (s2 + d2/2) % 1440);
      } else { // 日跨ぎ
        // 基準日の列→24:00、翌日の列→0:00〜w2
        addBar(targetDay, s2, 1440);
        addBar(nextIndex(targetDay), 0, w2);
        const mst2 = (s2 + d2/2) % 1440;
        if (mst2 >= s2) addMSTbar(targetDay, mst2); else addMSTbar(nextIndex(targetDay), mst2);
      }
    }
  });

  // グラフ描画
  const ctx = document.getElementById("mstChart").getContext('2d');
  Chart.getChart("mstChart")?.destroy();

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels, // 固定7曜日
      datasets: [
        { label: '睡眠', data: dsSleep, parsing: false, backgroundColor: '#7cc8ff', borderWidth: 0, barPercentage: 0.6, categoryPercentage: 0.9, stack: 'sleep' },
        { label: 'MST',   type:'bar', data: dsMST, parsing:false, backgroundColor:'#ffffff', borderWidth:0, barPercentage:0.9, categoryPercentage:0.9, stack:'mst', order:10 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: true },
        y: {
          stacked: true, min: 0, max: 1440,
          ticks: { stepSize: 120, callback: v => minToTime(v) },
          grid: { color: 'rgba(255,255,255,0.3)' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => {
              const v = ctx.raw?.y;
              if (Array.isArray(v)) return ` ${minToTime(v[0])}〜${minToTime(v[1])}`;
              return '';
            }
          }
        }
      }
    }
  });

  // 週評価（3日以上）
  if (count >= 3) {
    const diffT = Math.max(...totals) - Math.min(...totals);
    const diffM = Math.max(...msts)   - Math.min(...msts);
    const starT = diffT <= 120 ? 3 : diffT <= 180 ? 2 : 1;
    const starM = diffM <=  60 ? 3 : diffM <=  90 ? 2 : 1;
    document.getElementById("weeklyStats").innerText =
      `睡眠時間差: ${(diffT/60).toFixed(1)}h / MST差: ${(diffM/60).toFixed(1)}h`;
    const s = n => '★'.repeat(n) + '☆'.repeat(3-n);
    document.getElementById("starRatings").innerHTML = `合計: ${s(starT)}　MST: ${s(starM)}`;
  } else {
    document.getElementById("weeklyStats").innerText = "週評価: データが3日未満です";
    document.getElementById("starRatings").innerHTML = "";
  }
}

// 初期描画
evaluateAll();
</script>
</body>
</html>
