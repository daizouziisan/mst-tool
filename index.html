<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>睡眠記録</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    body { margin:0; font-family:'Noto Sans JP',sans-serif; background:#dff6fd; color:#000; }
    .header,.footer { padding:1rem; text-align:center; }
    .header-form { display:flex; flex-direction:column; align-items:center; gap:0.5rem; margin-top:0.5rem; }
    .header-form label { display:flex; align-items:center; gap:0.5rem; }
    .header-form input[type="time"], .header-form input[type="number"]{
      padding:0.15rem; border-radius:6px; border:1px solid #a7c9d8; width:80px; text-align:center;
      background:#fff;
    }
    .day-block{ margin:1rem auto; background:#f0fbff; padding:1rem; border-radius:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.08); max-width:460px; text-align:center; }
    .day-title{ font-size:1.1rem; margin-bottom:0.5rem; color:#007acc; font-weight:700; }
    .table-grid{ display:grid; grid-template-columns:1fr .3fr 1fr .8fr 1fr 1fr; align-items:center; text-align:center; font-size:.92rem; margin-bottom:.35rem; }
    .input-cell{ display:flex; justify-content:center; }
    button{ background:#66ccff; color:#003147; border:none; padding:.5rem .9rem; border-radius:8px; font-size:.92rem; cursor:pointer; margin:.5rem auto; display:block; }
    button:hover{ filter:brightness(0.95); }
    canvas{ max-width:95%; margin:1rem auto; display:block; background:linear-gradient(180deg,#e9faff,#e6f4ff); border-radius:12px; }
    .stars{ margin-top:1rem; text-align:center; }
    .stars img{ width:60px; margin:0 5px; vertical-align:middle; }
    #suggestionResult div{ margin:.3rem 0; }
  </style>
</head>
<body>
<div class="header">
  <h2>睡眠スケジュール</h2>
  <div class="header-form">
    <label>就寝予定時刻:<input type="time" id="plannedStart"></label>
    <label>希望睡眠時間(分):<input type="number" id="desiredDuration" min="0" max="1440" step="1"></label>
    <label>MST:<input type="time" id="targetMST"></label>
    <button onclick="suggestSleepTime()">提案</button>
    <div id="suggestionResult"></div>
  </div>
</div>

<div id="daysContainer"></div>

<div class="footer">
  <h3>週の統計とグラフ</h3>
  <button onclick="evaluateAll()">週の評価</button>
  <div id="weeklyStats"></div>
  <canvas id="sleepChart" height="420"></canvas>
  <div class="stars" id="starRatings"></div>
</div>

<script>
/* ================= 基本設定 ================= */
const weekdays = ["mon","tue","wed","thu","fri","sat","sun"];
const labelsJP  = ["月","火","水","木","金","土","日"];
const FOUR_AM = 240; // 4:00 (分)

/* ------------- ユーティリティ ------------- */
function focusNext(current, nextId){ if(current.value) document.getElementById(nextId).focus(); }
function timeToMin(t){ if(!t) return null; const [h,m] = t.split(":").map(Number); return h*60+m; }
function minToTime(min){
  if(min==null) return "--:--";
  min = (min + 1440) % 1440;
  const h = Math.floor(min/60).toString().padStart(2,"0");
  const m = Math.floor(min%60).toString().padStart(2,"0");
  return `${h}:${m}`;
}
/** 4:00基準の“その日の0〜1440分”へ変換 */
function toDayOffsetMinutes(min){ return (min - FOUR_AM + 1440) % 1440; }
/** 区間長(分)（終了が開始より小さい時は日またぎ） */
function spanMinutes(s,w){ return (w - s + 1440) % 1440; }

/* ------------- 入力UI生成 ------------- */
const container = document.getElementById("daysContainer");
weekdays.forEach((day,i)=>{
  const block = document.createElement("div");
  block.className="day-block";
  block.innerHTML = `
    <div class='day-title'>${labelsJP[i]}曜日</div>
    <div class='table-grid'><div>就寝</div><div></div><div>起床</div><div>点数</div><div>合計</div><div>MST</div></div>
    <div class='table-grid'>
      <div class='input-cell'><input type='time' id='${day}_s1' oninput="focusNext(this,'${day}_w1'); evaluateAll();"></div>
      <div>〜</div>
      <div class='input-cell'><input type='time' id='${day}_w1' oninput="evaluateAll();"></div>
      <div id='${day}_score1'>--点</div><div></div><div></div>
    </div>
    <div class='table-grid'><div></div><div></div><div></div><div></div>
      <div id='${day}_total'>--h--m</div><div id='${day}_mst'>--:--</div>
    </div>
    <div class='table-grid'>
      <div class='input-cell'><input type='time' id='${day}_s2' oninput="focusNext(this,'${day}_w2'); evaluateAll();"></div>
      <div>〜</div>
      <div class='input-cell'><input type='time' id='${day}_w2' oninput="evaluateAll();"></div>
      <div id='${day}_score2'>--点</div><div></div><div></div>
    </div>`;
  container.appendChild(block);
});
/* 週消去ボタン（入力欄の下に配置） */
const clearBtn = document.createElement("button");
clearBtn.textContent = "消去";
clearBtn.onclick = ()=>{
  weekdays.forEach(d=>{
    ["s1","w1","s2","w2"].forEach(t=>document.getElementById(`${d}_${t}`).value="");
    document.getElementById(`${d}_total`).innerText="--h--m";
    document.getElementById(`${d}_mst`).innerText="--:--";
    document.getElementById(`${d}_score1`).innerText="--点";
    document.getElementById(`${d}_score2`).innerText="--点";
  });
  document.getElementById("weeklyStats").innerText="";
  document.getElementById("starRatings").innerHTML="";
  Chart.getChart("sleepChart")?.destroy();
};
container.appendChild(clearBtn);

/* ------------- MST 提案 ------------- */
function suggestSleepTime(){
  const start = timeToMin(document.getElementById("plannedStart").value);
  const duration = parseInt(document.getElementById("desiredDuration").value);
  const targetMST = timeToMin(document.getElementById("targetMST").value);
  const resultDiv = document.getElementById("suggestionResult");
  resultDiv.innerHTML="";

  if(start==null || isNaN(duration) || targetMST==null){ resultDiv.innerText="入力が不完全です。"; return; }

  const candidates=[];
  for(let i=0;i<=180;i+=5){
    const s=(start+i)%1440;
    const maxDur=Math.min(duration,1440-i);
    for(let d=maxDur; d>=30; d-=5){
      const mst=(s+d/2)%1440;
      const diff=Math.min(Math.abs(mst-targetMST), 1440-Math.abs(mst-targetMST));
      if(diff<=30){ candidates.push({s,e:(s+d)%1440,d,mst,offset:i}); break; }
    }
  }
  if(!candidates.length){ resultDiv.innerText="適した時間帯が見つかりません。"; return; }
  candidates.sort((a,b)=>a.offset-b.offset || b.d-a.d);
  candidates.slice(0,3).forEach(c=>{
    const div=document.createElement("div");
    div.innerText=`${minToTime(c.s)}〜${minToTime(c.e)} (${c.d}分 MST:${minToTime(c.mst)})`;
    resultDiv.appendChild(div);
  });
}

/* ------------- 評価 & グラフ ------------- */
/**
 * 入力→セッション配列化（4:00区切り＆“2本目が4:00以降なら翌日扱い”）
 * 返り値:
 *  - segments: [{day,x,y:[start,end]}]（日をまたぐ場合は自動で分割）
 *  - perDay: { total:分, mst:分|null } …各日の「長い方の睡眠」のMST
 */
function buildWeekData(){
  const segments=[];
  const perDay = Array.from({length:7},()=>({total:0,mst:null,longest:0}));

  function pushSession(baseDay, s, w){
    if(s==null || w==null) return;

    const dur = spanMinutes(s,w);
    if(dur<=0) return;

    // その日の“4:00基準”オフセット
    let startOff = toDayOffsetMinutes(s);
    let endOff   = toDayOffsetMinutes(w);

    // 同日内 or 日またぎで分割
    if(endOff>startOff){
      segments.push({day:baseDay, x:labelsJP[baseDay], y:[startOff,endOff]});
    }else{
      // その日の残り
      segments.push({day:baseDay, x:labelsJP[baseDay], y:[startOff,1440]});
      // 翌日の頭
      const next = (baseDay+1)%7;
      segments.push({day:next, x:labelsJP[next], y:[0,endOff]});
    }

    // “その日”の長い方の睡眠でMSTを更新（MSTは開始日の属する日に置く）
    const mst = (s + dur/2) % 1440;
    if(dur > perDay[baseDay].longest){
      perDay[baseDay].longest = dur;
      perDay[baseDay].mst = mst;
    }
    // 合計は同一日の合算（分割分は雑に合算でOK：24h内で収まる）
    perDay[baseDay].total += dur;
  }

  weekdays.forEach((d,idx)=>{
    const s1=timeToMin(document.getElementById(`${d}_s1`).value);
    const w1=timeToMin(document.getElementById(`${d}_w1`).value);
    const s2=timeToMin(document.getElementById(`${d}_s2`).value);
    const w2=timeToMin(document.getElementById(`${d}_w2`).value);

    // 1本目：その曜日に属する
    pushSession(idx, s1, w1);

    // 2本目：開始が4:00以降なら翌日に属させて描画（ご要望仕様）
    if(s2!=null && s2>=FOUR_AM){
      const next = (idx+1)%7;
      pushSession(next, s2, w2);
    }else{
      pushSession(idx, s2, w2);
    }
  });

  // 表示用に total と mst のない日は null に
  perDay.forEach(d=>{
    if(d.longest===0){ d.mst=null; d.total=0; }
  });

  return {segments, perDay};
}

function evaluateAll(){
  // スコア・日別合計/MSTのテキスト更新（入力側の曜日で表示）
  weekdays.forEach((day)=>{
    const s1=timeToMin(document.getElementById(`${day}_s1`).value);
    const w1=timeToMin(document.getElementById(`${day}_w1`).value);
    const s2=timeToMin(document.getElementById(`${day}_s2`).value);
    const w2=timeToMin(document.getElementById(`${day}_w2`).value);
    const d1=(s1!=null && w1!=null)? spanMinutes(s1,w1):0;
    const d2=(s2!=null && w2!=null)? spanMinutes(s2,w2):0;

    const score1 = d1>0 ? Math.min(100, Math.round(d1/5.1)) : 0;
    const score2 = d2>0 ? Math.min(100 - score1, Math.round(d2/5.1)) : 0;

    document.getElementById(`${day}_score1`).innerText = d1>0? `${score1}点`:"--点";
    document.getElementById(`${day}_score2`).innerText = (d2>0 || (s2||w2))? `${score2}点`:"--点";
    const totalDisp = d1+d2;
    document.getElementById(`${day}_total`).innerText = totalDisp>0? `${Math.floor(totalDisp/60)}h${totalDisp%60}m`:"--h--m";
    const mstDisp = (d1>=d2 && d1>0)? (s1+d1/2)%1440 : (d2>0? (s2+d2/2)%1440 : null);
    document.getElementById(`${day}_mst`).innerText = mstDisp!=null? minToTime(mstDisp):"--:--";
  });

  // グラフ用データ作成（4:00基準＋分割＋2本目の4:00以降→翌日扱い）
  const {segments, perDay} = buildWeekData();

  // Chart.js 再生成（浮動バー + MST白線）
  const ctx = document.getElementById("sleepChart").getContext("2d");
  Chart.getChart("sleepChart")?.destroy();

  // x: 曜日, y: 0..1440 (4:00→翌4:00)
  const sleepDataset = {
    type: "bar",
    label: "睡眠",
    data: segments.map(seg=>({x: seg.x, y: [seg.y[0], seg.y[1]]})),
    borderRadius: 6,
    borderSkipped: false,
  };

  // MST（白い横棒）はプラグインで描画
  const mstByLabel = labelsJP.map((lab,i)=> perDay[i].mst!=null ? {x: lab, y: toDayOffsetMinutes(perDay[i].mst)} : null);

  const chart = new Chart(ctx,{
    type:"bar",
    data:{ labels: labelsJP, datasets:[sleepDataset] },
    options:{
      maintainAspectRatio:false,
      plugins:{ legend:{display:false}, tooltip:{
        callbacks:{
          label(ctx){
            const v = ctx.raw?.y;
            if(Array.isArray(v)){
              return `${minToTime(v[0]+FOUR_AM)}〜${minToTime(v[1]+FOUR_AM)}`;
            }
            return '';
          }
        }
      }},
      scales:{
        x:{ stacked:true },
        y:{
          min:0, max:1440, stacked:true,
          ticks:{ callback:v=>minToTime(v+FOUR_AM) }
        }
      }
    },
    plugins:[{
      id:"mst-lines",
      afterDatasetsDraw(c, args, pluginOpts){
        const {ctx, chartArea, scales:{x,y}} = c;
        ctx.save();
        ctx.lineWidth = 4;
        ctx.strokeStyle = "#ffffff";
        labelsJP.forEach((lab, idx)=>{
          const point = mstByLabel[idx];
          if(!point) return;
          const yPix = y.getPixelForValue(point.y);
          const xCenter = x.getPixelForValue(lab);
          const barW = x.getPixelForValue(lab) - x.left; // category half幅を概算
          const half = Math.min(Math.abs(barW)*0.45, 40);
          ctx.beginPath();
          ctx.moveTo(xCenter - half, yPix);
          ctx.lineTo(xCenter + half, yPix);
          ctx.stroke();
        });
        ctx.restore();
      }
    }]
  });

  // 週評価（データが3日以上ある日だけ対象）
  const usedTotals = [], usedMSTs=[];
  perDay.forEach(d=>{
    if(d.total>0 && d.mst!=null){ usedTotals.push(d.total); usedMSTs.push(d.mst); }
  });

  if(usedTotals.length>=3){
    const diffT = Math.max(...usedTotals) - Math.min(...usedTotals);
    // MST差は角度差（循環）で評価：各MSTを4:00基準にしてから直線距離→ただし循環最小に正規化
    const norm = m => toDayOffsetMinutes(m);
    const mNorm = usedMSTs.map(norm);
    const diffRaw = Math.max(...mNorm) - Math.min(...mNorm);
    const diffM = diffRaw; // 0..1440内

    const starT = diffT <= 120 ? 3 : diffT <= 180 ? 2 : 1;
    const starM = diffM <= 60 ? 3 : diffM <= 90 ? 2 : 1;

    document.getElementById("weeklyStats").innerText =
      `睡眠時間差:${(diffT/60).toFixed(1)}h  MST差:${(diffM/60).toFixed(1)}h`;
    document.getElementById("starRatings").innerHTML =
      `合計: <img src="images/star${starT}.png" alt="starT">　
       MST: <img src="images/star${starM}.png" alt="starM">`;
  }else{
    document.getElementById("weeklyStats").innerText="";
    document.getElementById("starRatings").innerHTML="";
  }
}
</script>
</body>
</html>
