<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>睡眠記録</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: 'Noto Sans JP', sans-serif; background: #dff6fd; color: #000; }
    .header, .footer { padding: 1rem; text-align: center; }
    .header-form { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; margin-top: 1rem; }
    .header-form label { display: flex; justify-content: center; align-items: center; gap: 0.5rem; }
    .header-form input[type="time"], .header-form input[type="number"],
    input[type="time"] { padding: 0.1rem; border-radius: 4px; border: 1px solid #aaa; width: 60px; text-align: center; }
    .day-block { margin: 1rem auto; background: #f0fbff; padding: 1rem; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 440px; text-align: center; }
    .day-title { font-size: 1.2rem; margin-bottom: 0.5rem; color: #007acc; }
    .table-grid { display: grid; grid-template-columns: 1fr 0.3fr 1fr 0.8fr 1fr 1fr; align-items: center; text-align: center; font-size: 0.9rem; margin-bottom: 0.3rem; }
    .input-cell { display: flex; justify-content: center; }
    button { background: #66ccff; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; margin: 0.5rem auto; display: block; }
    canvas { max-width: 95%; margin: 1rem auto; display: block; }
    .stars { margin-top: 1rem; text-align: center; }
    .stars img { width: 60px; margin: 0 5px; }
  </style>
</head>
<body>
<div class="header">
  <h2>睡眠スケジュール</h2>
  <div class="header-form">
    <label>就寝予定時刻:<input type="time" id="plannedStart"></label>
    <label>希望睡眠時間(分):<input type="number" id="desiredDuration" min="0" max="1440" step="1"></label>
    <label>MST:<input type="time" id="targetMST"></label>
    <button onclick="suggestSleepTime()">提案</button>
    <div id="suggestionResult"></div>
  </div>
</div>
<div id="daysContainer"></div>
<div class="footer">
  <h3>週の統計とグラフ</h3>
  <button onclick="evaluateAll()">週の評価</button>
  <div id="weeklyStats"></div>
  <canvas id="mstChart" height="400"></canvas>
  <div class="stars" id="starRatings"></div>
</div>
<script>
  const weekdays = ["mon","tue","wed","thu","fri","sat","sun"];
  const labels = ["月","火","水","木","金","土","日"];
  const container = document.getElementById("daysContainer");

  function focusNext(current, nextId) {
    if (current.value) document.getElementById(nextId).focus();
  }
  function timeToMin(t) {
    if (!t) return null;
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
  }
  function minToTime(min) {
    min = (min + 1440) % 1440;
    const h = Math.floor(min / 60).toString().padStart(2, "0");
    const m = Math.floor(min % 60).toString().padStart(2, "0");
    return `${h}:${m}`;
  }

  weekdays.forEach((day, i) => {
    const block = document.createElement("div");
    block.className = "day-block";
    block.innerHTML = `<div class='day-title'>${labels[i]}曜日</div>
      <div class='table-grid'><div>就寝</div><div></div><div>起床</div><div>点数</div><div>合計</div><div>MST</div></div>
      <div class='table-grid'>
        <div class='input-cell'><input type='time' id='${day}_s1' oninput="focusNext(this, '${day}_w1'); evaluateAll();"></div>
        <div>〜</div>
        <div class='input-cell'><input type='time' id='${day}_w1' oninput="evaluateAll();"></div>
        <div id='${day}_score1'>--点</div><div></div><div></div>
      </div>
      <div class='table-grid'><div></div><div></div><div></div><div></div>
        <div id='${day}_total'>--h--m</div><div id='${day}_mst'>--:--</div></div>
      <div class='table-grid'>
        <div class='input-cell'><input type='time' id='${day}_s2' oninput="focusNext(this, '${day}_w2'); evaluateAll();"></div>
        <div>〜</div>
        <div class='input-cell'><input type='time' id='${day}_w2' oninput="evaluateAll();"></div>
        <div id='${day}_score2'>--点</div><div></div><div></div>
      </div>`;
    container.appendChild(block);
  });

  const clearBtn = document.createElement("button");
  clearBtn.textContent = "消去";
  clearBtn.onclick = () => {
    weekdays.forEach(day => {
      ["s1","w1","s2","w2"].forEach(t => document.getElementById(`${day}_${t}`).value = "");
      document.getElementById(`${day}_total`).innerText = "--h--m";
      document.getElementById(`${day}_mst`).innerText = "--:--";
      document.getElementById(`${day}_score1`).innerText = "--点";
      document.getElementById(`${day}_score2`).innerText = "--点";
    });
    document.getElementById("weeklyStats").innerText = "";
    document.getElementById("starRatings").innerHTML = "";
    Chart.getChart("mstChart")?.destroy();
  };
  container.appendChild(clearBtn);

  function suggestSleepTime() {
    const start = timeToMin(document.getElementById("plannedStart").value);
    const duration = parseInt(document.getElementById("desiredDuration").value);
    const targetMST = timeToMin(document.getElementById("targetMST").value);
    if (start == null || isNaN(duration) || targetMST == null) {
      document.getElementById("suggestionResult").innerText = "入力が不完全です。"; return;
    }
    let s = start, e = (s + duration) % 1440, mst = (s + duration / 2) % 1440;
    const diff = Math.abs(mst - targetMST);
    document.getElementById("suggestionResult").innerText =
      diff <= 30 ? `${minToTime(s)}〜${minToTime(e)} (MST:${minToTime(mst)})` : "適した時間帯が見つかりません。";
  }

  function evaluateAll() {
    let msts = [], count = 0;
    weekdays.forEach(day => {
      const s1 = timeToMin(document.getElementById(`${day}_s1`).value);
      const w1 = timeToMin(document.getElementById(`${day}_w1`).value);
      const s2 = timeToMin(document.getElementById(`${day}_s2`).value);
      const w2 = timeToMin(document.getElementById(`${day}_w2`).value);
      const d1 = s1 != null && w1 != null ? (w1 - s1 + 1440) % 1440 : 0;
      const d2 = s2 != null && w2 != null ? (w2 - s2 + 1440) % 1440 : 0;
      if (d1 + d2 > 0) count++;
      const mst = d1 >= d2 ? (s1 + d1 / 2) % 1440 : (s2 + d2 / 2) % 1440;
      document.getElementById(`${day}_mst`).innerText = minToTime(mst);
      if (!isNaN(mst)) msts.push(mst);
    });

    if (msts.length > 0) {
      Chart.getChart("mstChart")?.destroy();
      new Chart(document.getElementById("mstChart"), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'MST',
            data: msts,
            backgroundColor: '#66ccff',
            barThickness: 30
          }]
        },
        options: {
          indexAxis: 'x',
          scales: {
            y: {
              min: 960,
              max: 2400,
              ticks: {
                callback: v => {
                  let h = Math.floor((v % 1440) / 60).toString().padStart(2, '0');
                  let m = Math.floor(v % 60).toString().padStart(2, '0');
                  return `${h}:${m}`;
                }
              }
            }
          }
        }
      });
    }
  }
</script>
</body>
</html>
