<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>睡眠記録</title>
  <!-- Chart.js v4 を固定 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
  <style>
    body { margin: 0; font-family: 'Noto Sans JP', system-ui, -apple-system, sans-serif; background: #dff6fd; color: #000; }
    .header, .footer { padding: 1rem; text-align: center; }
    .header-form { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
    .header-form label { display: flex; justify-content: center; align-items: center; gap: 0.5rem; }
    .header-form input[type="time"], .header-form input[type="number"] {
      padding: 0.1rem 0.3rem; border-radius: 6px; border: 1px solid #9ac9dc; width: 80px; text-align: center; background:#fff;
    }
    /* 2列グリッドで縦長を抑える（狭い画面は1列に自動） */
    #daysContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; max-width: 980px; margin: 0 auto; padding: 0 10px; }
    .day-block { background: #f0fbff; padding: 1rem; border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); text-align: center; }
    .day-title { font-size: 1.1rem; margin-bottom: 0.4rem; color: #0a80c0; }
    .table-grid { display: grid; grid-template-columns: 1fr 0.3fr 1fr 0.8fr 1fr 1fr; align-items: center; text-align: center; font-size: 0.92rem; margin-bottom: 0.25rem; }
    .input-cell { display: flex; justify-content: center; }
    button { background: #66ccff; border: none; padding: 0.45rem 0.9rem; border-radius: 8px; font-size: 0.95rem; cursor: pointer; }
    button:active { transform: translateY(1px); }
    canvas { max-width: 100%; margin: 1rem auto; display: block; background: #e9faff; border-radius: 12px; }
    .stars { margin-top: 0.6rem; text-align: center; }
    .stars img { width: 60px; margin: 0 6px; }
    #suggestionResult div { margin: 0.25rem 0; }
    .center { display: flex; justify-content: center; margin: 12px 0; }
  </style>
</head>
<body>
<div class="header">
  <h2>睡眠スケジュール</h2>
  <div class="header-form">
    <label>就寝予定時刻:<input type="time" id="plannedStart"></label>
    <label>希望睡眠時間(分):<input type="number" id="desiredDuration" min="0" max="1440" step="1"></label>
    <label>MST:<input type="time" id="targetMST"></label>
    <button onclick="suggestSleepTime()">提案</button>
    <div id="suggestionResult"></div>
  </div>
</div>

<div class="footer">
  <h3>週の統計とグラフ</h3>
  <button onclick="evaluateAll()">週の評価</button>
  <div id="weeklyStats"></div>
  <canvas id="mstChart" height="420"></canvas>
  <div class="stars" id="starRatings"></div>
</div>

<script>
/* ===== ユーティリティ ===== */
const weekdays = ["mon","tue","wed","thu","fri","sat","sun"];
const labelsJP = ["月","火","水","木","金","土","日"];
const GRAPH_OFFSET = 16 * 60; // グラフは16:00→翌16:00
let chartRef = null;

function focusNext(current, nextId) { if (current.value) document.getElementById(nextId).focus(); }
function timeToMin(t) { if (!t) return null; const [h, m] = t.split(":").map(Number); return h * 60 + m; }
function minToTime(min) { min = (min + 1440) % 1440; const h = String(Math.floor(min/60)).padStart(2,"0"); const m = String(min%60).padStart(2,"0"); return `${h}:${m}`; }
function toGraphCoord(min){ if(min==null) return null; return ((min - GRAPH_OFFSET) % 1440 + 1440) % 1440; }

/* ===== 入力カードの生成 ===== */
const container = document.getElementById("daysContainer");
weekdays.forEach((day, i) => {
  const block = document.createElement("div");
  block.className = "day-block";
  block.innerHTML = `<div class='day-title'>${labelsJP[i]}曜日</div>
    <div class='table-grid'><div>就寝</div><div></div><div>起床</div><div>点数</div><div>合計</div><div>MST</div></div>
    <div class='table-grid'>
      <div class='input-cell'><input type='time' id='${day}_s1' oninput="focusNext(this, '${day}_w1'); evaluateAll();"></div>
      <div>〜</div>
      <div class='input-cell'><input type='time' id='${day}_w1' oninput="evaluateAll();"></div>
      <div id='${day}_score1'>--点</div><div></div><div></div>
    </div>
    <div class='table-grid'><div></div><div></div><div></div><div></div>
      <div id='${day}_total'>--h--m</div><div id='${day}_mst'>--:--</div></div>
    <div class='table-grid'>
      <div class='input-cell'><input type='time' id='${day}_s2' oninput="focusNext(this, '${day}_w2'); evaluateAll();"></div>
      <div>〜</div>
      <div class='input-cell'><input type='time' id='${day}_w2' oninput="evaluateAll();"></div>
      <div id='${day}_score2'>--点</div><div></div><div></div>
    </div>`;
  container.appendChild(block);
});

/* ===== 消去ボタン ===== */
document.getElementById("clearBtn").onclick = () => {
  weekdays.forEach(day => {
    ["s1","w1","s2","w2"].forEach(t => document.getElementById(`${day}_${t}`).value = "");
    document.getElementById(`${day}_total`).innerText = "--h--m";
    document.getElementById(`${day}_mst`).innerText = "--:--";
    document.getElementById(`${day}_score1`).innerText = "--点";
    document.getElementById(`${day}_score2`).innerText = "--点";
  });
  document.getElementById("weeklyStats").innerText = "";
  document.getElementById("starRatings").innerHTML = "";
 <!-- 消去ボタンを常に中央に配置 -->
<div class="center"><button id="clearBtn">消去</button></div>

<div id="daysContainer"></div>
  // グラフだけ空に更新（枠は残す）
  if (chartRef) {
    chartRef.data.datasets[0].data = [];
    chartRef.data.datasets[1].data = [];
    chartRef.$mstLines = [];
    chartRef.update();
  }
};

/* ===== 就寝提案 ===== */
function suggestSleepTime() {
  const start = timeToMin(document.getElementById("plannedStart").value);
  const duration = parseInt(document.getElementById("desiredDuration").value);
  const targetMST = timeToMin(document.getElementById("targetMST").value);
  const resultDiv = document.getElementById("suggestionResult");
  resultDiv.innerHTML = "";
  if (start == null || isNaN(duration) || targetMST == null) { resultDiv.innerText = "入力が不完全です。"; return; }

  let candidates = [];
  for (let i = 0; i <= 180; i += 5) {
    let s = (start + i) % 1440;
    let maxDur = Math.min(duration, 1440 - i);
    for (let d = maxDur; d >= 30; d -= 5) {
      let mst = (s + d / 2) % 1440;
      let diff = Math.min(Math.abs(mst - targetMST), 1440 - Math.abs(mst - targetMST));
      if (diff <= 30) { candidates.push({s, d, mst, offset: i}); break; }
    }
  }
  if (!candidates.length) { resultDiv.innerText = "適した時間帯が見つかりません。"; return; }
  candidates.sort((a, b) => a.offset - b.offset || b.d - a.d);
  candidates.slice(0, 3).forEach(c => {
    const e = (c.s + c.d) % 1440;
    const div = document.createElement("div");
    div.innerText = `${minToTime(c.s)}〜${minToTime(e)} (${c.d}分 MST:${minToTime(c.mst)})`;
    resultDiv.appendChild(div);
  });
}

/* ===== グラフ（画像風） ===== */
const mstPlugin = {
  id:'mstLines',
  afterDatasetsDraw(chart){
    const {ctx, chartArea, scales:{x,y}} = chart;
    if(!x || !y || !chart.$mstLines?.length || !chartArea) return;
    const colW = Math.max(12, chartArea.width / Math.max(1, labelsJP.length));
    const half = colW * 0.35;
    ctx.save(); ctx.lineWidth = 4; ctx.strokeStyle = '#ffffff';
    chart.$mstLines.forEach(({dayIndex, coord})=>{
      const xC = x.getPixelForValue(labelsJP[dayIndex]);
      const yP = y.getPixelForValue(coord);
      if(Number.isFinite(xC) && Number.isFinite(yP)){
        ctx.beginPath(); ctx.moveTo(xC - half, yP); ctx.lineTo(xC + half, yP); ctx.stroke();
      }
    });
    ctx.restore();
  }
};

function buildOrUpdateChart(segPrimary, segSecondary, mstLines){
  const cfg = {
    type:'bar',
    data:{
      labels: labelsJP, // 常に週の枠を表示
      datasets:[
        {label:'睡眠（MST側）', data:segPrimary, parsing:{xAxisKey:'x', yAxisKey:'y'},
         borderRadius:8, borderSkipped:false, backgroundColor:'#66ccff', barPercentage:.56, categoryPercentage:.72},
        {label:'睡眠（MSTなし側）', data:segSecondary, parsing:{xAxisKey:'x', yAxisKey:'y'},
         borderRadius:8, borderSkipped:false, backgroundColor:'rgba(102,204,255,0.35)', barPercentage:.56, categoryPercentage:.72}
      ]
    },
    options:{
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:(ctx)=>{
          const rng = (ctx.raw && ctx.raw.y) ? ctx.raw.y : [0,0];
          const s = minToTime((rng[0]+GRAPH_OFFSET)%1440);
          const e = minToTime((rng[1]+GRAPH_OFFSET)%1440);
          const d = ((rng[1]-rng[0]+1440)%1440);
          return `${s}〜${e}（${Math.floor(d/60)}h${d%60}m）`;
        }}}
      },
      scales:{
        x:{grid:{display:false}},
        y:{min:0, max:1440, ticks:{stepSize:120, callback:v=>minToTime((v+GRAPH_OFFSET)%1440)}}
      }
    },
    plugins:[mstPlugin]
  };

  const ctx = document.getElementById("mstChart").getContext('2d');
  if(!chartRef){ chartRef = new Chart(ctx, cfg); }
  else{
    chartRef.data.datasets[0].data = segPrimary;
    chartRef.data.datasets[1].data = segSecondary;
    chartRef.update();
  }
  chartRef.$mstLines = mstLines; // 白線データ
}

/* ===== 再計算＆描画 ===== */
function evaluateAll() {
  let count = 0, totals = [], msts = [];
  const segPrimary = [];      // MSTを含む帯（濃い）
  const segSecondary = [];    // MSTを含まない帯（薄い）
  const mstLines = [];        // {dayIndex, coord}

  weekdays.forEach((day, i) => {
    const s1 = timeToMin(document.getElementById(`${day}_s1`).value);
    const w1 = timeToMin(document.getElementById(`${day}_w1`).value);
    const s2 = timeToMin(document.getElementById(`${day}_s2`).value);
    const w2 = timeToMin(document.getElementById(`${day}_w2`).value);

    const d1 = (s1!=null && w1!=null) ? (w1 - s1 + 1440) % 1440 : 0;
    const d2 = (s2!=null && w2!=null) ? (w2 - s2 + 1440) % 1440 : 0;
    const total = d1 + d2;

    // スコア表示
    const score1 = d1 > 0 ? Math.min(100, Math.round(d1 / 5.1)) : 0;
    const score2 = d2 > 0 ? Math.min(100 - score1, Math.round(d2 / 5.1)) : 0;
    document.getElementById(`${day}_total`).innerText = `${Math.floor(total/60)}h${total%60}m`;
    document.getElementById(`${day}_score1`).innerText = `${score1}点`;
    document.getElementById(`${day}_score2`).innerText = `${score2}点`;

    // 長い方のMST（もう片方は薄色で描く）
    const useFirst = (d1 >= d2);
    const use = useFirst ? {s:s1, d:d1} : {s:s2, d:d2};
    const mst = (use.d>0 && use.s!=null) ? (use.s + use.d/2) % 1440 : null;
    document.getElementById(`${day}_mst`).innerText = mst!=null ? minToTime(mst) : "--:--";

    if (total > 0 && mst != null) {
      count++; totals.push(total); msts.push(mst);
      mstLines.push({ dayIndex:i, coord: toGraphCoord(mst) });
    }

    // 帯を作成（16:00境界で分割して翌日にまたがせる）
    function pushSeg(startMin, durMin, primary){
      if(startMin==null || durMin<=0) return;
      const endMin = (startMin + durMin) % 1440;
      let sC = toGraphCoord(startMin), eC = toGraphCoord(endMin);
      const push = (xIndex, y0, y1, p)=>{ const obj = { x: labelsJP[xIndex], y:[y0,y1] }; (p?segPrimary:segSecondary).push(obj); };
      if(eC > sC){ push(i, sC, eC, primary); }
      else{        // 境界跨ぎ
        push(i, sC, 1440, primary);
        push((i+1)%7, 0, eC, primary);
      }
    }
    pushSeg(s1, d1, useFirst);      // MST側＝濃い
    pushSeg(s2, d2, !useFirst);     // MSTなし側＝薄い
  });

  // グラフ更新
  buildOrUpdateChart(segPrimary, segSecondary, mstLines);

  // ★週評価（3日以上で表示）
  const starBox = document.getElementById("starRatings");
  const statBox = document.getElementById("weeklyStats");
  if (count >= 3) {
    const diffT = Math.max(...totals) - Math.min(...totals);
    const diffM = Math.max(...msts) - Math.min(...msts);
    const starT = diffT <= 120 ? 3 : diffT <= 180 ? 2 : 1;
    const starM = diffM <=  60 ? 3 : diffM <=  90 ? 2 : 1;
    statBox.innerText = `睡眠時間差:${(diffT/60).toFixed(1)}h　MST差:${(diffM/60).toFixed(1)}h`;
    starBox.innerHTML = `合計:<img src="images/star${starT}.png" alt="${starT}">　MST:<img src="images/star${starM}.png" alt="${starM}">`;
  } else {
    statBox.innerText = "";
    starBox.innerHTML = "";
  }
}

// 初期描画
evaluateAll();
</script>
</body>
</html>
